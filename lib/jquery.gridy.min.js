/*!
 * jQuery Gridy - A Grid Plugin
 *
 * Licensed under The MIT License
 *
 * @version        1.0.0
 * @author         Washington Botelho
 * @documentation  wbotelhos.com/gridy
 *
 */

;(function(b){var a={init:function(c){return this.each(function(){var d=this,e=b(d).empty();d.opt=b.extend({},b.fn.gridy.defaults,c);d.wrapper=e.data("settings",d.opt).wrap('<div id="'+d.id+'-wrapper" />').parent();d.currentPage=b('<input type="hidden" name="page" value="'+d.opt.page+'" />').insertBefore(d);d.currentSortName=b('<input type="hidden" name="sortName" value="'+d.opt.sortName+'" />').insertBefore(d);d.currentSortOrder=b('<input type="hidden" name="sortOrder" value="'+d.opt.sortOrder+'" />').insertBefore(d);d.isTable=d.opt.style=="table";d.hasColumns=d.opt.columns.length>0;d.hasHeaders=d.opt.headers.length>0||d.hasColumns;d.hasFinds=d.opt.finds.length>0;d.hasRows=d.opt.rowsNumber.length>0;d.myWidth=a.getSize.call(d,d.opt.width);d.myHeight=a.getSize.call(d,d.opt.height);if(d.opt.width){d.wrapper.width(d.myWidth);}if(d.opt.width){e.width(d.myWidth);}if(d.isTable){e.attr("cellspacing",0).parent().addClass(d.opt.skin+"-table");}else{e.parent().addClass(d.opt.skin);}a.buildSearcher.call(d);a.buildStatus.call(d);a.buildHeader.call(d);a.buildContent.call(d);a.buildFooter.call(d);a.buildFinder.call(d);a.buildRower.call(d);a.buildRefresher.call(d);a.buildPageButtons.call(d);a.buildMessager.call(d);if(d.opt.firstQuery){a.data.call(d,d.opt.page,d.opt.sortName,d.opt.sortOrder);}else{a.noResult.call(d,d.opt.noFirstQueryText);}});},buildContent:function(){var d=this;if(d.isTable){d.content=b('<tbody class="gridy-content" />');}else{d.content=b('<div class="gridy-content" />');if(d.opt.width){d.content.width(d.myWidth);}if(d.opt.height){d.content.height(d.myHeight);}}d.content.appendTo(d);if(d.opt.scroll){if(!d.opt.height||d.opt.height=="auto"){a.error.call(d,d.id+": height attribute missing!");}if(d.isTable){var e=d.content.parent("table"),c=e.wrap('<div class="gridy-scroll" />').parent("div");if(d.opt.height){c.height(d.myHeight);}if(d.opt.width){c.width(a.getSize.call(d,d.opt.width+15));}var f=e.clone(true).removeAttr("id");f.children("tbody").remove();f.insertBefore(c);e.children("thead").remove();}else{d.content.addClass("gridy-scroll");}}},buildFinder:function(){var c=this;if(c.hasFinds){c.findBox=b('<div class="gridy-find-option"><select></select></div>').appendTo((c.opt.searchOption)?c.search.children():c.footer).children();var g=false,e="",d,h;for(var f in c.opt.finds){d=c.opt.finds[f].name;h=c.opt.finds[f].value;if(!d){a.error.call(c,c.id+": finds["+f+"].name missing!");}if(!h){a.error.call(c,c.id+": finds["+f+"].value missing!");}e+='<option value="'+h+'">'+d+"</option>";if(h==c.opt.find){g=true;}}if(!g){e='<option value="'+c.opt.find+'" checked="checked">'+c.opt.find+"</option>"+e;}c.findBox.html(e).val(c.opt.find).change().change(function(i,j){if(c.opt.searchOption&&c.opt.searchFocus){c.searchField.focus();}}).children('option[value="'+c.opt.find+'"]').attr("checked","checked");}if(c.opt.findTarget){if(!c.hasFinds){a.error.call(c,c.id+": you need set the 'finds' option for find box be created!");}c.findBox.parent().appendTo(c.opt.findTarget);}},buildFooter:function(){var c=this;if(c.hasRows||c.opt.messageOption||(!c.opt.searchOption&&c.hasFinds)){c.footer=b('<div class="gridy-footer" />').appendTo(c.wrapper);if(c.opt.resize&&c.opt.width){c.footer.width(c.myWidth);}}},buildHeader:function(){var m=this;if(m.hasHeaders){var f;if(m.isTable){f=b('<thead class="gridy-header"><tr></tr></thead>').appendTo(m).children("tr");}else{f=b('<div class="gridy-header" />').appendTo(m);if(m.opt.resize&&m.opt.width){f.width(m.myWidth);}}if(m.opt.headers<=0){m.opt.headers=m.opt.columns;}var c,l,d,g,k,j,h;for(var e in m.opt.headers){c=m.opt.headers[e].name;l=m.opt.headers[e].value;d=m.opt.headers[e].width;g=m.opt.headers[e].clazz;j=b("<a />",{href:"javascript:void(0);"});h=b("<div />");if(c){j.html(c);}if(l){j.attr({id:"sort-by-"+l,name:l});if(c){h.addClass(m.opt.arrowNone);}}else{j.addClass("gridy-no-sort");}if(!c||!l){h.addClass("gridy-arrow-empty");}k=b((m.isTable)?"<th />":"<div />").append(j,h);if(d){if(m.isTable){k.attr("width",d);}else{k.width(d);}}if(g){k.addClass(g);}k.appendTo(f);}m.sorters=f.children().children("a").click(function(){a.sort.call(m,b(this));});var n=m.sorters.filter("#sort-by-"+m.opt.sortName);if(n.length){a.flick.call(m,n,m.opt.sortOrder,undefined);}}},buildMessager:function(){var c=this;if(c.opt.messageOption){c.messager=b('<div class="gridy-message" />').appendTo(c.footer);}},buildPageButtons:function(){var c=this;if(c.opt.buttonOption){var d=b('<div class="gridy-buttons"><div class="gridy-buttons-content"></div></div>').appendTo(c.wrapper);if(c.opt.resize&&c.opt.width){d.width(c.myWidth);}c.pageButtons=d.children();}},buildRefresher:function(){var c=this;if(c.opt.refreshOption){c.refresher=b('<input type="button" class="'+c.opt.refreshIcon+'" />').click(function(){a.data.call(c,c.currentPage.val(),c.currentSortName.val(),c.currentSortOrder.val());});}if(c.opt.refreshTarget){if(!c.opt.refreshOption){a.error.call(c,c.id+": you must turn the 'refreshOption' to true to use 'refreshTarget'!");}c.refresher.appendTo(c.opt.refreshTarget);}else{c.refresher.appendTo(c.footer);}},buildRower:function(){var d=this;if(d.hasRows){d.rower=b('<div class="gridy-row-option"><select></select></div>').children();var h=(d.opt.rows<1)?1:d.opt.rows,c=false,e="",g;for(var f in d.opt.rowsNumber){g=d.opt.rowsNumber[f];if(g==h){c=true;}e+='<option value="'+g+'">'+a.getNumber.call(d,g)+"</option>";}if(!c){e='<option value="'+h+'" checked="checked">'+a.getNumber.call(d,h)+"</option>"+e;}d.rower.html(e).val(h).change().change(function(i,j){a.data.call(d,1,d.currentSortName.val(),d.currentSortOrder.val(),b(d));}).children('option[value="'+h+'"]').attr("checked","checked");}if(d.opt.rowsTarget){if(!d.hasRows){a.error.call(d,d.id+": you need set the 'rowsNumber' option for rows box be created!");}d.rower.parent().appendTo(d.opt.rowsTarget);}else{d.rower.parent().appendTo(d.footer);}},buildSearcher:function(){var c=this;if(c.opt.searchOption){c.search=b('<div class="gridy-search"><div class="gridy-search-content"></div></div>');if(c.opt.resize&&c.opt.width){c.search.width(c.myWidth);}var d=c.search.children();c.searchField=b('<input type="text" name="search" value="'+((c.opt.search=="")?c.opt.searchText:c.opt.search)+'" title="'+c.opt.searchText+'" size="40" />').appendTo(d);c.searchField.blur(function(){if(c.searchField.val()==""){c.searchField.removeClass("gridy-typed").val(c.opt.searchText);}}).focus(function(){if(c.searchField.val()==c.opt.searchText){c.searchField.addClass("gridy-typed").val("");}}).keypress(function(e){if((e.keyCode?e.keyCode:e.which)==13){a.data.call(c,1,c.currentSortName.val(),c.currentSortOrder.val());}});c.searchButton=b('<input type="button" value="'+c.opt.searchButtonLabel+'" title="'+c.opt.searchButtonTitle+'" />').click(function(){a.data.call(c,1,c.currentSortName.val(),c.currentSortOrder.val());}).appendTo(d);if(c.opt.searchTarget){c.search.appendTo(c.opt.searchTarget);}else{c.search.insertBefore(b(c));}}},buildStatus:function(){var c=this;if(c.opt.loadingOption||c.opt.statusOption){c.statusBox=b('<div class="gridy-status" />').insertBefore(b(c));if(c.opt.resize&&c.opt.width){c.statusBox.width(c.myWidth);}}if(c.opt.loadingOption){c.loading=b('<div class="'+c.opt.loadingIcon+'"><div>'+c.opt.loadingText+"</div></div>").appendTo(c.statusBox).children().hide();}if(c.opt.statusOption){c.result=b('<div class="gridy-result" />').appendTo(c.statusBox);}},data:function(k,m,e){var n=this;a.enableGrid.call(n,false);a.loading.call(n,true);if(n.opt.before){var p=n.opt.before.call(n,k,m,e);if(p){if(p.page){k=p.page;}if(p.sortName){m=p.sortName;}if(p.sortOrder){e=p.sortOrder;}}}var o=n.opt.search,j=(n.hasRows)?n.rower.val():n.opt.rows,d=(n.hasFinds)?n.findBox.val():n.opt.find;if(n.opt.searchOption){o=(n.searchField.val()==n.opt.searchText)?"":n.searchField.val();if(n.opt.searchFocus){n.searchField.focus();}}if(n.opt.data){a.process.call(n,n.opt.data,k,m,e);return;}var h={search:o,page:k,sortName:m,sortOrder:e,find:d,rows:j};for(var c in n.opt.params){h[c]=n.opt.params[c];}for(var c in n.opt.paramsElements){var g=n.opt.paramsElements[c];b(g).each(function(r){var s=b(this);if(s.is(":enabled")&&!s.is(":checkbox")||s.is(":checked")){if(g.indexOf(".")==0){var t=h[this.name],q=[];if(t){for(var r in t){q.push(t[r]);}}q.push(this.value);h[this.name]=q;}else{h[this.name]=this.value;}}});}if(n.opt.debug){var l="[debug] query string:\n\n";for(var c in h){l+=c;for(var f=0;f<(20-c.length);f++){l+=" ";}l+=": "+(h[c]||"''")+"\n";}if(window.console&&window.console.log){window.console.log(l);}}b.ajax({cache:n.opt.cache,contentType:n.opt.contentType,dataType:n.opt.dataType,jsonp:n.opt.jsonp,jsonpCallback:n.opt.jsonpCallback,type:n.opt.type,url:n.opt.url,data:h,success:function(q,r,i){a.process.call(n,q,k,m,e,j);if(n.opt.hoverFx){n.content.children(':not("p")').mouseenter(function(){b(this).addClass("gridy-row-hovered");}).mouseleave(function(){b(this).removeClass("gridy-row-hovered");});}if(n.opt.clickFx){n.content.children(':not("p")').click(function(s){var t=b(this);if(!s.ctrlKey&&!s.metaKey){t.parent().children(".gridy-row-selected").removeClass("gridy-row-selected");}t.toggleClass("gridy-row-selected");});}if(n.opt.done){n.opt.done.call(n,q,r,i);}},error:function(i,r,q){a.message.call(n,a.getError.call(n,i));if(n.opt.fail){n.opt.fail.call(n,i,r,q);}},complete:function(q,r){a.loading.call(n,false);a.enableGrid.call(n,true);if(n.opt.scroll){if(n.isTable){n.content.children(":first").addClass("gridy-first-line");}else{n.content.children(":last").addClass("gridy-last-line");}}else{if(n.isTable){n.content.children("tr:last").children("td").addClass("gridy-last-line");}if(n.opt.separate){var i=n.content.children(":first");if(n.isTable){i=i.children("td");}i.addClass("gridy-separate");}}if(n.opt.always){n.opt.always.call(n,q,r);}}});},enableGrid:function(c){var d=this;if(c){if(d.opt.searchOption){d.searchField.removeAttr("readonly");d.searchButton.removeAttr("disabled");}if(d.hasHeaders){d.sorters.filter(':not(".gridy-no-sort")').click(function(){a.sort.call(d,b(this));});}if(d.opt.buttonOption){d.pageButtons.children(':not(".gridy-button-reticence")').removeAttr("disabled");}if(d.hasFinds){d.findBox.removeAttr("disabled");}if(d.hasRows){d.rower.removeAttr("disabled");}if(d.opt.refreshOption){d.refresher.removeAttr("disabled");}}else{if(d.opt.searchOption){d.searchField.attr("readonly","readonly");d.searchButton.attr("disabled","disabled");}if(d.hasHeaders){d.sorters.unbind("click");}if(d.opt.buttonOption){d.pageButtons.attr("disabled","disabled");}if(d.hasFinds){d.findBox.attr("disabled","disabled");}if(d.hasRows){d.rower.attr("disabled","disabled");}if(d.opt.refreshOption){d.refresher.attr("disabled","disabled");}}},error:function(c){this.wrapper.html('<div class="gridy-error">'+c+"</div>");b.error(c);},flick:function(g,d,f){var c=this,e=(d=="asc")?c.opt.arrowUp:c.opt.arrowDown;if(f){f.removeAttr("rel").removeClass("gridy-sorted").next("div").removeClass().addClass(c.opt.arrowNone);}g.attr("rel",d).addClass("gridy-sorted").next("div").removeClass().addClass(e);},getError:function(c){return(c.responseText)?c.responseText.substring(c.responseText.indexOf("(")+1,c.responseText.indexOf(")")):c.statusText;},getNumber:function(c){return(c<10)?"0"+c:c;},getSize:function(c){return(isNaN(parseInt(c,10)))?c:c+"px";},loading:function(c){var d=this;if(d.opt.loadingOption){if(c){d.loading.fadeIn("fast");d.content.children().children().addClass("gridy-fade");}else{d.loading.fadeOut();d.content.children().children().removeClass("gridy-fade");}}},message:function(d){var c=this;if(c.opt.messageOption){c.messager.html(d).show();setTimeout(function(){c.messager.fadeOut(function(){c.messager.hide().empty();});},c.opt.messageTimer);}},noResult:function(d){var c=this;if(c.opt.resultOption){c.content.html('<p class="gridy-no-result">'+(d||"")+"</p>");if(c.opt.statusOption){c.result.html(c.result.html().replace(/\d+/g,"0"));}if(c.opt.searchOption){c.searchField.focus().select();}}},process:function(E,o,e,x,w){var v=this;if(typeof(E)=="string"){E=b.parseJSON(E);}if(v.opt.filter){var n=v.opt.filter.call(v,E,o,e,x);if(n){E=n;if(typeof(E)=="string"){E=b.parseJSON(E);}}}var r=v.opt.totalPath.split("."),F=0,g;for(var A in r){g=r[A];F=(A==0)?E[g]:F[g];}if(F==0){a.noResult.call(v,v.opt.noResultText);if(v.opt.buttonOption){v.pageButtons.empty();}return;}var f=v.opt.listPath.split("."),C=[];for(var A in f){g=f[A];C=(A==0)?E[g]:C[g];}v.content.html(b("#"+v.opt.template).tmpl(C));if(v.opt.evenOdd){v.content.children(":even").addClass((v.opt.scroll)?"gridy-even":"gridy-even").end().children(":odd").addClass((v.opt.scroll)?"gridy-odd":"gridy-odd");}var y;v.content.children().each(function(){b(this).children().each(function(i){if(v.opt.columns[i]){y=v.opt.columns[i].width;if(v.isTable){b(this).attr("width",y);}else{b(this).width(y);}}});});var u=F%w,j=(F-u)/w;if(u>0){j++;}if(v.opt.statusOption){var D=v.opt.statusText.replace("{from}",a.getNumber.call(v,o)).replace("{to}",a.getNumber.call(v,j)).replace("{total}",a.getNumber.call(v,F));v.result.html(D);}if(v.opt.buttonOption){if(F>w){var s='<input type="button" value="..." disabled="disabled" class="gridy-button-reticence"/>&#160;',B="",d=0,c=undefined,m=1,l=v.opt.buttonMax,q=(l%2==0);if(l>j){l=j;}if(q){c=Math.ceil(l/2);m=o-c+1;}else{c=Math.floor(l/2);m=o-c;}var h=parseInt(o,10)+c;if(m==0){h++;m=1;}if(m<0){h+=Math.abs(m)+1;m=1;}if(h>j){if(m>1){if(m===(h-j)){m=1;}else{m-=(h-j);}}h=j;}var k=j>l,p=k&&o>((q)?c:c+1),z=k&&o<(j-c);if(p){B='<input type="button" value="&lsaquo;" alt="'+v.opt.buttonBackTitle+'" title="'+v.opt.buttonBackTitle+'" class="gridy-back"/>&#160;';B+=s;}for(var A=m;A<=h;A++){d=a.getNumber.call(v,A);B+='<input type="button" value="'+d+'" alt="'+d+'" title="'+v.opt.buttonTitle+" "+d+'"/>&#160;';}if(z){B+=s;B+='<input type="button" value="&rsaquo;" alt="'+v.opt.buttonNextTitle+'" title="'+v.opt.buttonNextTitle+'" class="gridy-next"/>&#160;';}var t=v.pageButtons.html(B).children('input:button:not(".gridy-back, .gridy-reticence, .gridy-next")');t.click(function(){a.data.call(v,parseInt(this.alt,10),v.currentSortName.val(),v.currentSortOrder.val());}).filter('[value="'+a.getNumber.call(v,o)+'"]').attr("disabled","disabled").addClass("gridy-button-active");if(p){v.pageButtons.children(".gridy-back").click(function(){a.data.call(v,o-1,v.currentSortName.val(),v.currentSortOrder.val());});}if(z){v.pageButtons.children(".gridy-next").click(function(){a.data.call(v,o+1,v.currentSortName.val(),v.currentSortOrder.val());});}}else{v.pageButtons.empty();}}v.currentPage.val(o);v.currentSortName.val(e);v.currentSortOrder.val(x);},reload:function(){a.set.call(this,{});},set:function(c){return this.each(function(){var d=b(this),f=d.data("settings"),e=d.parent();if(f.scroll&&f.style=="table"){e=e.parent();}d.insertBefore(e);e.remove();d.gridy(b.extend({},f,c));});},sort:function(h){var c=this,e=h.attr("name"),d=h.attr("rel"),f=(d&&d=="asc")?"desc":"asc",g=c.sorters.filter(".gridy-sorted");a.flick.call(c,h,f,g);a.data.call(c,c.currentPage.val(),e,f);}};b.fn.gridy=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1));}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments);}else{b.error("Method "+c+" does not exist!");}}};b.fn.gridy.defaults={always:undefined,cache:undefined,contentType:undefined,dataType:"json",done:undefined,fail:undefined,jsonp:undefined,jsonpCallback:undefined,page:1,params:{},paramsElements:[],sortName:"",sortOrder:"asc",type:"get",url:"/gridy",before:undefined,filter:undefined,columns:[],height:undefined,scroll:false,style:"table",width:undefined,evenOdd:false,resize:true,separate:true,skin:"gridy",clickFx:false,hoverFx:false,find:"",finds:[],findTarget:undefined,arrowDown:"gridy-arrow-down",arrowNone:"gridy-arrow-none",arrowUp:"gridy-arrow-up",headers:[],buttonBackTitle:"&lsaquo; Back",buttonMax:10,buttonNextTitle:"Next &rsaquo;",buttonOption:true,buttonTitle:"Page",listPath:"list",totalPath:"total",template:"template",loadingIcon:"gridy-loading",loadingOption:true,loadingText:"Loading...",messageOption:true,messageTimer:4000,debug:false,refreshIcon:"gridy-button-refresh",refreshOption:true,refreshTarget:undefined,firstQuery:true,noFirstQueryText:"No search was performed yet!",noResultText:"No item was found!",resultOption:true,rows:10,rowsNumber:[5,10,25,50,100],rowsTarget:undefined,search:"",searchButtonLabel:"search",searchButtonTitle:"Start the search",searchFocus:true,searchOption:true,searchTarget:undefined,searchText:"",statusOption:true,statusText:"Displaying {from} - {to} of {total} items"};})(jQuery);
